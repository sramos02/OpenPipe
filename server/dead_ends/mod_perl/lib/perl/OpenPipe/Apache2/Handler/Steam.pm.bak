package OpenPipe::Apache2::Handler::Steam; 

use strict;
use warnings;

use Apache2::Filter ();
use Apache2::RequestRec ();
use Apache2::SubRequest ();
use Apache2::RequestUtil ();
use Apache2::RequestIO ();
use APR::Table ();

use Apache2::Const -compile => qw(OK);

use constant BUFF_LEN => 1024;


sub handler { 
    my $f = shift;              # Our filter object
	my $bb = shift;
 	
    # Unset our Content-Length header since we will be changing
    # the content's length.
    unless( $f->ctx ) {
	   $f->ctx(1); 
       $f->r->headers_out->unset('Content-Length'); 
    }

    # Read the file 1024 bytes at a time
    while( $f->read(my $buf, BUFF_LEN) ) { 

         # Replace the closing BODY tag with our last modified 
         # date and time 
         if( $buf =~ /<\/BODY>/i ) { 
            $buf =~ s/<\/BODY>/Modified!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<\/BODY>/i; 
         }

        $f->print($buf); 
		
    }

	#if($f->r->is_initial_req()){
	#	if($f->seen_eos){
	#		$f->r->rflush();
	#		my $sub = $f->r->lookup_uri("/openpipe/subindex.html");
	#		$sub->run();
	#	}
	#}

    return Apache2::Const::OK; 
}
1;